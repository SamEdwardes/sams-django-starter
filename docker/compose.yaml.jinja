name: {{ project_name }}

volumes:
  caddy_data:
  caddy_config:
  postgres_data:

services:
  # ---------------------------------------------------------------------------
  # Postgres database
  # ---------------------------------------------------------------------------
  postgres:
    image: "postgres:17"
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
    volumes:
      - postgres_data:/var/lib/postgresql/data/

  # ---------------------------------------------------------------------------
  # Caddy reverse proxy
  # ---------------------------------------------------------------------------
  caddy:
    restart: unless-stopped
    image: {{ project_name }}-caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ../Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config

  # ---------------------------------------------------------------------------
  # Django web app
  # ---------------------------------------------------------------------------
  web-app:
    depends_on:
      - postgres
    image: {{ project_name }}-app
    restart: unless-stopped
    command: sh -c "/app/.venv/bin/python manage.py migrate && /app/.venv/bin/python -m uvicorn --host 0.0.0.0 --port 8000 {{ project_name }}.asgi:application"
    environment:
      - DJANGO_DEBUG=0
      - DJANGO_SECRET_KEY
      - POSTGRES_HOST=postgres
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
      - LOGFIRE_TOKEN
      - LOGFIRE_SERVICE_NAME=django-app

  # ---------------------------------------------------------------------------
  # Django-tasks background job runner
  # ---------------------------------------------------------------------------
  tasks-queue:
    depends_on:
      - postgres
      - web-app
    restart: unless-stopped
    image: {{ project_name }}-app
    command: ["/app/.venv/bin/python", "manage.py", "db_worker"]
    environment:
      - DJANGO_DEBUG=0
      - DJANGO_SECRET_KEY
      - POSTGRES_HOST=postgres
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
      - LOGFIRE_TOKEN
      - LOGFIRE_SERVICE_NAME=django-tasks
